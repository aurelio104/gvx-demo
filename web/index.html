<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>GVX City Screens · Reserva 15 segundos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      color-scheme:dark;
      --bg:#020617;
      --card:rgba(15,23,42,0.96);
      --border:rgba(148,163,184,0.45);
      --accent:#38bdf8;
      --accent2:#a855f7;
      --ok:#22c55e;
      --err:#fb7185;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      min-height:100vh;
      background:radial-gradient(circle at top,#0f172a 0,#020617 50%,#000 100%);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:1040px;
    }
    header{
      margin-bottom:12px;
    }
    header h1{
      margin:0;
      font-size:22px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    header h1 span.logo{
      width:28px;height:28px;border-radius:999px;
      background:linear-gradient(135deg,#38bdf8,#a855f7);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#020617;
    }
    header p{
      margin:4px 0 0;
      font-size:13px;
      opacity:.75;
    }
    .card{
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--border);
      padding:16px 18px 18px;
      box-shadow:0 22px 60px rgba(0,0,0,0.65);
      backdrop-filter:blur(24px) saturate(160%);
    }
    .steps{
      display:flex;
      gap:8px;
      margin-bottom:12px;
      font-size:11px;
    }
    .step-pill{
      flex:1;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(51,65,85,0.9);
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:rgba(15,23,42,0.9);
      opacity:.6;
    }
    .step-pill.active{
      border-color:var(--accent);
      background:linear-gradient(135deg,rgba(56,189,248,0.12),rgba(168,85,247,0.18));
      opacity:1;
    }
    .step-pill span:nth-child(1){font-weight:500;}
    .step-pill span:nth-child(2){font-size:10px;opacity:.8;}
    .step-panel{display:none;}
    .step-panel.active{display:block;}
    .grid{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:16px;
    }
    @media (max-width:900px){
      .grid{grid-template-columns:1fr;}
    }
    label{
      display:block;
      font-size:11px;
      margin-bottom:4px;
      opacity:.9;
    }
    input,select,textarea{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(51,65,85,0.9);
      background:rgba(15,23,42,0.96);
      padding:7px 10px;
      color:#e5e7eb;
      font-size:13px;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,0.7);
    }
    input[type="file"]{padding:6px 8px;}
    input[type="time"]{font-variant-numeric:tabular-nums;}
    .field{margin-bottom:10px;}
    .tiny{font-size:10px;opacity:.65;}
    .actions{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .btn{
      border-radius:999px;
      border:none;
      padding:7px 16px;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      background:#0f172a;
      color:#e5e7eb;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#020617;
      box-shadow:0 12px 30px rgba(56,189,248,0.55);
    }
    .btn[disabled]{opacity:.55;cursor:default;box-shadow:none;}
    .status{
      font-size:11px;
      margin-top:6px;
      min-height:14px;
    }
    .status.ok{color:var(--ok);}
    .status.err{color:var(--err);}
    .slots-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      gap:8px;
    }
    .slots-controls{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      font-size:11px;
    }
    .slots-controls select{
      width:auto;
      padding:4px 8px;
      font-size:11px;
      border-radius:999px;
    }
    .slots-grid{
      border-radius:18px;
      border:1px solid rgba(51,65,85,0.9);
      max-height:260px;
      overflow:auto;
      padding:6px;
      background:radial-gradient(circle at top,#020617,#020617);
      font-size:11px;
    }
    .slot-row{
      display:flex;
      align-items:center;
      gap:4px;
      margin-bottom:2px;
    }
    .slot-minute-label{
      width:46px;
      text-align:right;
      opacity:.6;
      font-variant-numeric:tabular-nums;
    }
    .slot{
      border-radius:999px;
      border:1px solid rgba(51,65,85,0.9);
      background:rgba(15,23,42,0.96);
      padding:3px 8px;
      font-size:10px;
      cursor:pointer;
      min-width:40px;
    }
    .slot.free{color:#e5e7eb;}
    .slot.busy{background:rgba(127,29,29,0.9);border-color:rgba(248,113,113,0.9);color:#fee2e2;cursor:not-allowed;}
    .slot.past{opacity:.35;cursor:not-allowed;}
    .slot.selected{background:rgba(22,163,74,0.9);border-color:#4ade80;color:#022c22;}
    .summary{
      font-size:11px;
      opacity:.85;
      margin-top:4px;
    }
    video{
      width:100%;
      max-height:260px;
      border-radius:18px;
      border:1px solid rgba(30,64,175,0.75);
      background:#000;
      object-fit:contain;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:3px 10px;
      font-size:10px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.5);
      margin-bottom:10px;
    }
    .pill-dot{
      width:7px;height:7px;border-radius:999px;
      background:radial-gradient(circle,#22c55e,#16a34a);
      box-shadow:0 0 8px rgba(34,197,94,0.8);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1><span class="logo">G</span> GVX City Screens</h1>
      <p>Reserva 15 segundos en pantallas urbanas · selección de slots en tiempo real.</p>
    </header>
    <div class="card">
      <div class="steps">
        <div class="step-pill" id="stepPill1"><span>Paso 1 · Agenda tu slot</span><span>Fecha y pantalla</span></div>
        <div class="step-pill" id="stepPill2"><span>Paso 2 · Sube tu video</span><span>Recorte y preview</span></div>
        <div class="step-pill" id="stepPill3"><span>Paso 3 · Confirma</span><span>Pago y resumen</span></div>
      </div>

      <!-- PASO 1 -->
      <section id="step1" class="step-panel active">
        <span class="pill"><span class="pill-dot"></span>Paso 1 · Agenda tu slot</span>
        <div class="grid">
          <div>
            <div class="field">
              <label for="apiUrl">API URL (demo · Koyeb)</label>
              <input id="apiUrl" type="text" value="https://deep-lorrie-aurelio104-6f5545e3.koyeb.app" />
              <div class="tiny">En producción usa aquí la URL del API desplegado en Koyeb.</div>
            </div>
            <div class="field">
              <label for="dateInput">Fecha</label>
              <input id="dateInput" type="date" />
            </div>
            <div class="field">
              <label for="citySelect">Ciudad</label>
              <select id="citySelect">
                <option>Maracay</option>
                <option>Caracas</option>
                <option>Valencia</option>
              </select>
            </div>
            <div class="field">
              <label for="screenSelect">Pantalla</label>
              <select id="screenSelect">
                <option>CC Los Aviadores · Entrada principal</option>
                <option>CC Los Aviadores · Piso 2</option>
                <option>Av. Bolívar · LED 01</option>
              </select>
            </div>
            <div class="field">
              <label>Slot de 15 segundos</label>
              <div class="slots-header">
                <div class="tiny">Elige la hora, luego un bloque de 15 segundos disponible (verde).</div>
                <div class="slots-controls">
                  <span>Hora:</span>
                  <select id="hourSelect"></select>
                </div>
              </div>
              <div id="slotSummary" class="summary">Ningún slot seleccionado.</div>
            </div>
          </div>
          <div>
            <div class="field">
              <label>Hora actual</label>
              <div class="tiny" id="nowLabel">—</div>
            </div>
            <div class="field">
              <label>Disponibilidad (bloques de 15s)</label>
              <div id="slotsContainer" class="slots-grid"></div>
            </div>
          </div>
        </div>
        <div class="actions">
          <span class="status" id="status1"></span>
          <button class="btn primary" id="toStep2">Continuar</button>
        </div>
      </section>

      <!-- PASO 2 -->
      <section id="step2" class="step-panel">
        <span class="pill"><span class="pill-dot"></span>Paso 2 · Sube tu video</span>
        <div class="grid">
          <div>
            <div class="field">
              <label for="fileInput">Archivo de video</label>
              <input id="fileInput" type="file" accept="video/*" />
              <div class="tiny">Idealmente 15 segundos o más, el sistema recorta al estándar de 15s.</div>
            </div>
            <div class="field">
              <label for="startInput">Inicio dentro del archivo (segundos)</label>
              <input id="startInput" type="number" min="0" value="0" />
            </div>
            <div class="actions">
              <button class="btn" id="backTo1">Volver</button>
              <button class="btn primary" id="processBtn">Procesar preview</button>
            </div>
            <div id="status2" class="status"></div>
          </div>
          <div>
            <label>Preview del recorte (15s)</label>
            <video id="previewVideo" controls muted></video>
          </div>
        </div>
      </section>

      <!-- PASO 3 -->
      <section id="step3" class="step-panel">
        <span class="pill"><span class="pill-dot"></span>Paso 3 · Confirmación</span>
        <div class="grid">
          <div>
            <h3 style="margin:0 0 8px;font-size:15px;">Resumen de tu reserva</h3>
            <div class="tiny" id="summaryText">—</div>
            <div class="field" style="margin-top:12px;">
              <label>Simular pago</label>
              <div class="tiny">En la versión demo solo se simula el pago. En producción aquí iría el proveedor de pagos.</div>
            </div>
            <div class="actions">
              <button class="btn" id="backTo2">Volver</button>
              <button class="btn primary" id="payBtn">Simular pago y programar</button>
            </div>
            <div id="status3" class="status"></div>
          </div>
          <div>
            <label>Preview del spot programado</label>
            <video id="previewFinal" controls muted></video>
          </div>
        </div>
      </section>
    </div>
  </div>
<script>
(function(){
  var state = {
    apiBase: "",
    selectedDate: null,
    selectedHour: null,
    selectedSlotKey: null,
    scheduledAtIso: null,
    city: "",
    screen: "",
    file: null,
    trimStart: 0,
    scheduleFromApi: null
  };

  var stepPill1 = document.getElementById("stepPill1");
  var stepPill2 = document.getElementById("stepPill2");
  var stepPill3 = document.getElementById("stepPill3");
  var step1 = document.getElementById("step1");
  var step2 = document.getElementById("step2");
  var step3 = document.getElementById("step3");

  function setStep(n){
    [step1,step2,step3].forEach(function(el){el.classList.remove("active");});
    [stepPill1,stepPill2,stepPill3].forEach(function(el){el.classList.remove("active");});
    if(n===1){step1.classList.add("active");stepPill1.classList.add("active");}
    if(n===2){step2.classList.add("active");stepPill2.classList.add("active");}
    if(n===3){step3.classList.add("active");stepPill3.classList.add("active");}
  }

  var apiInput = document.getElementById("apiUrl");
  var dateInput = document.getElementById("dateInput");
  var citySelect = document.getElementById("citySelect");
  var screenSelect = document.getElementById("screenSelect");
  var hourSelect = document.getElementById("hourSelect");
  var nowLabel = document.getElementById("nowLabel");
  var slotsContainer = document.getElementById("slotsContainer");
  var slotSummary = document.getElementById("slotSummary");
  var status1 = document.getElementById("status1");

  var fileInput = document.getElementById("fileInput");
  var startInput = document.getElementById("startInput");
  var status2 = document.getElementById("status2");
  var previewVideo = document.getElementById("previewVideo");

  var summaryText = document.getElementById("summaryText");
  var status3 = document.getElementById("status3");
  var previewFinal = document.getElementById("previewFinal");

  function updateClock(){
    nowLabel.textContent = new Date().toLocaleString();
  }
  updateClock();
  setInterval(updateClock,1000);

  // llenar horas 0-23
  for(var h=0;h<24;h++){
    var opt=document.createElement("option");
    opt.value=String(h);
    opt.textContent=(h<10?"0":"")+h+":00";
    hourSelect.appendChild(opt);
  }

  function initDateHourDefaults(){
    var now = new Date();
    var yyyy = now.getFullYear();
    var mm = String(now.getMonth()+1).padStart(2,"0");
    var dd = String(now.getDate()).padStart(2,"0");
    dateInput.value = yyyy+"-"+mm+"-"+dd;
    state.selectedDate = dateInput.value;
    state.selectedHour = now.getHours();
    hourSelect.value = String(state.selectedHour);
  }
  initDateHourDefaults();

  function loadExistingSchedule(){
    state.scheduleFromApi = null;
    var api = apiInput.value.trim().replace(/\/$/,"");
    state.apiBase = api;
    if(!api){renderSlots();return;}
    fetch(api + "/schedule/next", {cache:"no-store"})
      .then(function(res){
        if(!res.ok) return null;
        return res.json();
      })
      .then(function(data){
        if(data && !data.error){
          state.scheduleFromApi = data;
        }
        renderSlots();
      })
      .catch(function(){
        renderSlots();
      });
  }

  function renderSlots(){
    var dateStr = dateInput.value;
    if(!dateStr){
      slotsContainer.innerHTML = "<div class='tiny'>Selecciona una fecha para ver los slots.</div>";
      return;
    }
    var selectedHour = Number(hourSelect.value || "0");
    state.selectedDate = dateStr;
    state.selectedHour = selectedHour;

    var now = new Date();

    var busyKey = null;
    if(state.scheduleFromApi){
      var s = new Date(state.scheduleFromApi.startTime);
      var sY = s.getFullYear();
      var sM = String(s.getMonth()+1).padStart(2,"0");
      var sD = String(s.getDate()).padStart(2,"0");
      var sDateStr = sY+"-"+sM+"-"+sD;
      if(sDateStr === dateStr && s.getHours() === selectedHour){
        var m = String(s.getMinutes()).padStart(2,"0");
        var sec = String(s.getSeconds()).padStart(2,"0");
        busyKey = String(selectedHour).padStart(2,"0")+":"+m+":"+sec;
      }
    }

    slotsContainer.innerHTML = "";
    for(var minute=0; minute<60; minute++){
      var row = document.createElement("div");
      row.className = "slot-row";
      var label = document.createElement("div");
      label.className = "slot-minute-label";
      label.textContent = String(selectedHour).padStart(2,"0")+":"+String(minute).padStart(2,"0");
      row.appendChild(label);
      [0,15,30,45].forEach(function(sec){
        var key = String(selectedHour).padStart(2,"0")+":"+String(minute).padStart(2,"0")+":"+String(sec).padStart(2,"0");
        var slotTime = new Date(dateStr+"T"+key);
        var btn = document.createElement("button");
        btn.className = "slot";
        btn.textContent = ":"+String(sec).padStart(2,"0");
        btn.dataset.key = key;

        var status = "free";
        if(dateStr === (now.toISOString().slice(0,10)) && slotTime.getTime() <= now.getTime()){
          status = "past";
        }
        if(busyKey && key === busyKey){
          status = "busy";
        }

        btn.classList.add(status);
        if(status !== "free"){btn.disabled = true;}

        if(state.selectedSlotKey === key && status === "free"){
          btn.classList.add("selected");
        }

        row.appendChild(btn);
      });
      slotsContainer.appendChild(row);
    }

    if(state.selectedSlotKey && state.scheduledAtIso){
      slotSummary.textContent = "Slot seleccionado: "+ new Date(state.scheduledAtIso).toLocaleString();
    }else{
      slotSummary.textContent = "Ningún slot seleccionado.";
    }
  }

  slotsContainer.addEventListener("click", function(e){
    var btn = e.target.closest("button.slot");
    if(!btn || btn.disabled){return;}
    var key = btn.dataset.key;
    var dateStr = dateInput.value;
    if(!dateStr){return;}
    var iso = new Date(dateStr+"T"+key).toISOString();
    state.selectedSlotKey = key;
    state.scheduledAtIso = iso;
    renderSlots();
  });

  apiInput.addEventListener("change", loadExistingSchedule);
  dateInput.addEventListener("change", renderSlots);
  hourSelect.addEventListener("change", renderSlots);

  loadExistingSchedule();

  // Paso 1 -> Paso 2
  document.getElementById("toStep2").addEventListener("click", function(){
    status1.textContent = "";
    status1.className = "status";
    var api = apiInput.value.trim().replace(/\/$/,"");
    if(!api){
      status1.textContent = "Configura primero la API URL.";
      status1.classList.add("err");
      return;
    }
    if(!state.scheduledAtIso){
      status1.textContent = "Selecciona un slot de 15 segundos.";
      status1.classList.add("err");
      return;
    }
    state.apiBase = api;
    state.city = citySelect.value;
    state.screen = screenSelect.value;
    setStep(2);
  });

  document.getElementById("backTo1").addEventListener("click", function(){
    setStep(1);
  });

  // Paso 2: subida + preview
  fileInput.addEventListener("change", function(){
    status2.textContent = "";
    status2.className = "status";
    if(fileInput.files && fileInput.files[0]){
      state.file = fileInput.files[0];
    }else{
      state.file = null;
    }
  });

  document.getElementById("processBtn").addEventListener("click", function(){
    status2.textContent = "";
    status2.className = "status";
    if(!state.file){
      status2.textContent = "Selecciona un archivo de video primero.";
      status2.classList.add("err");
      return;
    }
    var api = state.apiBase;
    if(!api){
      status2.textContent = "Falta API URL.";
      status2.classList.add("err");
      return;
    }
    var start = Number(startInput.value) || 0;
    state.trimStart = start;

    var fd = new FormData();
    fd.append("file", state.file);
    fd.append("start", String(start));

    var btn = this;
    btn.disabled = true;
    btn.textContent = "Procesando…";

    fetch(api + "/media/trim", {
      method:"POST",
      body:fd
    }).then(function(res){
      if(!res.ok){throw new Error("Error al generar preview");}
      return res.blob();
    }).then(function(blob){
      var url = URL.createObjectURL(blob);
      previewVideo.src = url;
      previewVideo.play().catch(function(){});
      status2.textContent = "Preview generada correctamente.";
      status2.classList.add("ok");
    }).catch(function(err){
      console.error(err);
      status2.textContent = err.message || "Error inesperado";
      status2.classList.add("err");
    }).finally(function(){
      btn.disabled = false;
      btn.textContent = "Procesar preview";
    });
  });

  // Paso 2 -> Paso 3
  document.getElementById("backTo2").addEventListener("click", function(){
    setStep(2);
  });

  document.getElementById("backTo2").addEventListener("click", function(){
    setStep(2);
  });

  document.getElementById("backTo2").addEventListener("click", function(){
    setStep(2);
  });

  document.getElementById("backTo2").onclick = function(){ setStep(2); };

  document.getElementById("backTo1").onclick = function(){ setStep(1); };

  document.getElementById("backTo2").onclick = function(){ setStep(2); };

  document.getElementById("backTo2").onclick = function(){ setStep(2); };

  document.getElementById("backTo2").onclick = function(){ setStep(2); };

  // Navegar a Paso 3 cuando hay preview
  document.getElementById("backTo2"); // placeholder para no romper nada

  // Botón "Simular pago" en Paso 3
  document.getElementById("backTo2").addEventListener("click", function(){
    setStep(2);
  });

  document.getElementById("backTo1").addEventListener("click", function(){
    setStep(1);
  });

  document.getElementById("processBtn").addEventListener("dblclick", function(){
    // atajo: si ya hay preview, permite avanzar
    if(previewVideo.src){
      setStep(3);
      fillSummary();
    }
  });

  function fillSummary(){
    var when = state.scheduledAtIso ? new Date(state.scheduledAtIso).toLocaleString() : "—";
    summaryText.textContent =
      "Ciudad: " + state.city + " · Pantalla: " + state.screen +
      " · Slot: " + when +
      " · Duración: 15 segundos.";
  }

  document.getElementById("toStep2").addEventListener("dblclick", function(){
    // por si quieres saltar rápido, no obligatorio
    setStep(2);
  });

  document.getElementById("backTo2").addEventListener("dblclick", function(){
    setStep(3);
    fillSummary();
  });

  // Botón de pago real (Paso 3)
  document.getElementById("backTo2").removeEventListener("dblclick", function(){});
  var payBtn = document.getElementById("payBtn");
  payBtn.addEventListener("click", function(){
    status3.textContent = "";
    status3.className = "status";
    if(!state.file){
      status3.textContent = "Falta el archivo de video (sube en Paso 2).";
      status3.classList.add("err");
      return;
    }
    if(!state.scheduledAtIso){
      status3.textContent = "Falta el slot de 15 segundos.";
      status3.classList.add("err");
      return;
    }
    var api = state.apiBase;
    if(!api){
      status3.textContent = "Falta API URL.";
      status3.classList.add("err");
      return;
    }
    fillSummary();

    var fd = new FormData();
    fd.append("file", state.file);
    fd.append("start", String(state.trimStart || 0));
    fd.append("scheduledAt", state.scheduledAtIso);
    fd.append("city", state.city);
    fd.append("screen", state.screen);

    payBtn.disabled = true;
    payBtn.textContent = "Programando…";

    fetch(api + "/media/trim-set", {
      method:"POST",
      body:fd
    }).then(function(res){
      return res.text().then(function(text){
        if(!res.ok){throw new Error(text || "Error al programar spot");}
        try{return JSON.parse(text);}catch(_){return {raw:text};}
      });
    }).then(function(data){
      status3.textContent = "Pago simulado y spot programado correctamente. ID: " + (data.schedule && data.schedule.id ? data.schedule.id : "—");
      status3.classList.add("ok");
      var url = api + "/media/current?ts=" + Date.now();
      previewFinal.src = url;
      previewFinal.play().catch(function(){});
      setStep(3);
    }).catch(function(err){
      console.error(err);
      status3.textContent = err.message || "Error inesperado";
      status3.classList.add("err");
    }).finally(function(){
      payBtn.disabled = false;
      payBtn.textContent = "Simular pago y programar";
    });
  });

  // Navegar normal a paso 3 cuando ya hay preview (click en título de resumen)
  summaryText.addEventListener("click", function(){
    setStep(3);
  });
})();
</script>
</body>
</html>
