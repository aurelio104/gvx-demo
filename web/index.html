<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>GVX City Screens · Reserva tu spot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      color-scheme:dark;
      --bg:#020617;
      --card:rgba(15,23,42,0.96);
      --border:rgba(148,163,184,0.45);
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,0.18);
      --danger:#fb7185;
      --ok:#4ade80;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#1e293b 0,#020617 55%,#000 100%);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      color:#e5e7eb;
      padding:16px;
    }
    .shell{
      width:100%;
      max-width:960px;
      background:var(--card);
      border-radius:28px;
      border:1px solid var(--border);
      box-shadow:0 26px 80px rgba(0,0,0,0.7);
      backdrop-filter:blur(22px) saturate(160%);
      padding:20px 22px 22px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:14px;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:30px;height:30px;border-radius:999px;
      background:radial-gradient(circle at 30% 0,#38bdf8,#6366f1 55%,#0f172a 100%);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:18px;color:#e5e7eb;
      box-shadow:0 0 0 2px rgba(15,23,42,0.8);
    }
    h1{margin:0;font-size:18px;}
    .subtitle{margin:0;font-size:12px;opacity:.75;}
    .steps-bar{
      position:relative;
      height:4px;
      border-radius:999px;
      background:rgba(31,41,55,0.85);
      overflow:hidden;
      margin-bottom:18px;
    }
    .steps-bar-fill{
      position:absolute;left:0;top:0;bottom:0;
      width:33.334%;
      background:linear-gradient(90deg,#38bdf8,#a855f7);
      transition:width .25s ease-out;
    }
    .steps-header{
      display:flex;
      gap:10px;
      margin-bottom:8px;
      font-size:11px;
      opacity:.75;
    }
    .steps-header span.active{opacity:1;font-weight:600;}
    .grid{
      display:grid;
      grid-template-columns: minmax(0, 6fr) minmax(0, 5fr);
      gap:18px;
    }
    @media (max-width:900px){
      .grid{grid-template-columns:1fr;}
    }
    label{
      display:block;
      font-size:11px;
      margin-bottom:4px;
      opacity:.9;
    }
    input,select,textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(51,65,85,0.9);
      background:rgba(15,23,42,0.96);
      padding:8px 11px;
      color:#e5e7eb;
      font-size:13px;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,0.6);
    }
    input[type="file"]{padding:6px 9px;}
    input[type="range"]{
      padding:0;
      background:transparent;
    }
    .field{margin-bottom:10px;}
    .tiny{font-size:10px;opacity:.6;}
    .row{display:flex;gap:8px;}
    .row > *{flex:1;}
    button{
      border-radius:999px;
      border:none;
      padding:8px 16px;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      background:#0f172a;
      color:#e5e7eb;
    }
    button.primary{
      background:linear-gradient(135deg,#38bdf8,#a855f7);
      color:#020617;
      box-shadow:0 14px 34px rgba(56,189,248,0.55);
    }
    button[disabled]{opacity:.55;cursor:default;box-shadow:none;}
    .btn-row{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:6px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:4px 10px;
      font-size:10px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.5);
      margin-bottom:10px;
    }
    .dot{
      width:7px;height:7px;border-radius:999px;
      background:radial-gradient(circle,#22c55e,#16a34a);
      box-shadow:0 0 8px rgba(34,197,94,0.8);
    }
    video{
      width:100%;
      border-radius:18px;
      border:1px solid rgba(30,64,175,0.7);
      background:#000;
      max-height:280px;
      object-fit:contain;
    }
    .status{
      font-size:11px;
      min-height:14px;
      margin-top:6px;
    }
    .status.ok{color:var(--ok);}
    .status.err{color:var(--danger);}
    .tag{
      display:inline-flex;align-items:center;
      padding:3px 8px;border-radius:999px;
      font-size:10px;
      background:var(--accent-soft);
      color:#e5e7eb;
    }
    .summary{
      font-size:12px;
      padding:10px 12px;
      border-radius:16px;
      border:1px dashed rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
    }
    .summary-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .summary-label{opacity:.65;}
    .summary-value{font-weight:500;}
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="logo">G</div>
        <div>
          <h1>GVX City Screens</h1>
          <p class="subtitle">Reserva 15 segundos en pantallas urbanas.</p>
        </div>
      </div>
      <div class="tag">Demo · Beta</div>
    </header>

    <div class="steps-bar"><div id="stepsFill" class="steps-bar-fill"></div></div>
    <div class="steps-header">
      <span id="stepLabel1" class="active">Paso 1 · Agenda tu slot</span>
      <span id="stepLabel2">Paso 2 · Video</span>
      <span id="stepLabel3">Paso 3 · Pago</span>
    </div>

    <div class="grid">
      <!-- LADO IZQUIERDO -->
      <div>
        <!-- PASO 1 -->
        <div id="step1">
          <span class="pill"><span class="dot"></span>Fecha y pantalla</span>
          <div class="field">
            <label for="apiUrl">API URL (demo)</label>
            <input id="apiUrl" type="text" value="https://deep-lorrie-aurelio104-6f5545e3.koyeb.app" />
            <div class="tiny">En producción coloca aquí la URL del API en Koyeb.</div>
          </div>
          <div class="field">
            <label for="dateInput">Fecha</label>
            <input id="dateInput" type="date" />
          </div>
          <div class="row">
            <div class="field">
              <label for="hourSelect">Hora</label>
              <select id="hourSelect"></select>
            </div>
            <div class="field">
              <label for="minuteSelect">Minuto</label>
              <select id="minuteSelect"></select>
            </div>
            <div class="field">
              <label for="secondSelect">Segundos (bloque 15s)</label>
              <select id="secondSelect">
                <option value="0">00</option>
                <option value="15">15</option>
                <option value="30">30</option>
                <option value="45">45</option>
              </select>
            </div>
          </div>
          <div class="field">
            <label for="cityInput">Ciudad</label>
            <input id="cityInput" type="text" value="Maracay" />
          </div>
          <div class="field">
            <label for="screenInput">Pantalla</label>
            <select id="screenInput">
              <option>CC Los Aviadores · Entrada principal</option>
              <option>CC Los Aviadores · Patio de comida</option>
              <option>Av. Principal · Pantalla 01</option>
              <option>Av. Principal · Pantalla 02</option>
            </select>
          </div>
          <div id="slotInfo" class="tiny"></div>
          <div id="existingSlotInfo" class="tiny" style="margin-top:4px;"></div>
          <div class="btn-row">
            <button class="primary" id="step1Next">Continuar</button>
          </div>
          <div id="statusStep1" class="status"></div>
        </div>

        <!-- PASO 2 -->
        <div id="step2" style="display:none;">
          <span class="pill"><span class="dot"></span>Video · Recorta tu anuncio</span>
          <div class="field">
            <label for="videoFile">Archivo de video</label>
            <input id="videoFile" type="file" accept="video/*" />
          </div>
          <div class="field">
            <label for="startRange">Inicio dentro del archivo (segundos)</label>
            <input id="startRange" type="range" min="0" max="60" step="0.5" value="0" />
            <div class="tiny">El sistema generará un spot de 15 segundos a partir de este punto.</div>
          </div>
          <div class="btn-row">
            <button id="backTo1">Volver</button>
            <button id="continueTo3" disabled>Continuar al pago</button>
            <button class="primary" id="processVideoBtn">Procesar video</button>
          </div>
          <div id="statusStep2" class="status"></div>
        </div>

        <!-- PASO 3 -->
        <div id="step3" style="display:none;">
          <span class="pill"><span class="dot"></span>Pago y confirmación</span>
          <div class="summary" id="summaryBox">
            <div class="summary-row">
              <span class="summary-label">Pantalla</span>
              <span class="summary-value" id="summaryScreen">—</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Ciudad</span>
              <span class="summary-value" id="summaryCity">—</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Horario</span>
              <span class="summary-value" id="summaryTime">—</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Duración</span>
              <span class="summary-value">15 segundos</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Orden</span>
              <span class="summary-value" id="summaryOrder">Se generará al pagar</span>
            </div>
          </div>
          <div class="field" style="margin-top:10px;">
            <label>Pago demo</label>
            <div class="tiny">En este demo, el botón de abajo simula un pago aprobado y programa el spot en el API.</div>
          </div>
          <div class="btn-row">
            <button id="backTo2">Volver</button>
            <button class="primary" id="payBtn">Simular pago y programar</button>
          </div>
          <div id="statusStep3" class="status"></div>
        </div>
      </div>

      <!-- LADO DERECHO: preview -->
      <div>
        <label>Preview del spot recortado</label>
        <video id="previewVideo" controls muted></video>
        <div class="tiny" style="margin-top:6px;">Este preview se genera desde el endpoint /media/trim del API y no afecta a la programación final.</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const state = {
    step: 1,
    apiBase: "",
    scheduledAtIso: null,
    scheduledLocal: "",
    city: "",
    screen: "",
    file: null,
    trimStart: 0,
    previewReady: false,
    orderId: null
  };

  const stepsFill = document.getElementById("stepsFill");
  const stepLabel1 = document.getElementById("stepLabel1");
  const stepLabel2 = document.getElementById("stepLabel2");
  const stepLabel3 = document.getElementById("stepLabel3");
  const step1El = document.getElementById("step1");
  const step2El = document.getElementById("step2");
  const step3El = document.getElementById("step3");

  const apiInput = document.getElementById("apiUrl");
  const dateInput = document.getElementById("dateInput");
  const hourSelect = document.getElementById("hourSelect");
  const minuteSelect = document.getElementById("minuteSelect");
  const secondSelect = document.getElementById("secondSelect");
  const cityInput = document.getElementById("cityInput");
  const screenInput = document.getElementById("screenInput");
  const slotInfo = document.getElementById("slotInfo");
  const existingSlotInfo = document.getElementById("existingSlotInfo");
  const statusStep1 = document.getElementById("statusStep1");
  const step1Next = document.getElementById("step1Next");

  const videoFileInput = document.getElementById("videoFile");
  const startRange = document.getElementById("startRange");
  const processVideoBtn = document.getElementById("processVideoBtn");
  const continueTo3Btn = document.getElementById("continueTo3");
  const statusStep2 = document.getElementById("statusStep2");
  const backTo1 = document.getElementById("backTo1");

  const previewVideo = document.getElementById("previewVideo");

  const summaryScreen = document.getElementById("summaryScreen");
  const summaryCity = document.getElementById("summaryCity");
  const summaryTime = document.getElementById("summaryTime");
  const summaryOrder = document.getElementById("summaryOrder");
  const statusStep3 = document.getElementById("statusStep3");
  const backTo2 = document.getElementById("backTo2");
  const payBtn = document.getElementById("payBtn");

  function setStep(n){
    state.step = n;
    step1El.style.display = n === 1 ? "block" : "none";
    step2El.style.display = n === 2 ? "block" : "none";
    step3El.style.display = n === 3 ? "block" : "none";
    stepLabel1.classList.toggle("active", n === 1);
    stepLabel2.classList.toggle("active", n === 2);
    stepLabel3.classList.toggle("active", n === 3);
    stepsFill.style.width = n === 1 ? "33.34%" : n === 2 ? "66.67%" : "100%";
  }

  // ----- TIME & SLOT -----
  (function initTimeSelectors(){
    const now = new Date();
    const todayStr = now.toISOString().slice(0,10);
    dateInput.value = todayStr;

    hourSelect.innerHTML = "";
    for(let h=0; h<24; h++){
      const opt = document.createElement("option");
      opt.value = String(h);
      opt.textContent = String(h).padStart(2,"0");
      hourSelect.appendChild(opt);
    }
    minuteSelect.innerHTML = "";
    for(let m=0; m<60; m++){
      const opt = document.createElement("option");
      opt.value = String(m);
      opt.textContent = String(m).padStart(2,"0");
      minuteSelect.appendChild(opt);
    }

    hourSelect.value = String(now.getHours());
    minuteSelect.value = String(now.getMinutes());
    secondSelect.value = "0";
    updateSlotDisplay(null);
  })();

  function getSelectedSlotIso(){
    const date = dateInput.value;
    if(!date) return null;
    const h = parseInt(hourSelect.value || "0", 10);
    const m = parseInt(minuteSelect.value || "0", 10);
    const s = parseInt(secondSelect.value || "0", 10);
    const local = date + "T" + String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
    const dt = new Date(local);
    if(isNaN(dt.getTime())) return null;
    return dt.toISOString();
  }

  function updateSlotDisplay(existingSchedule){
    const iso = getSelectedSlotIso();
    if(!iso){
      slotInfo.textContent = "";
      return;
    }
    const local = new Date(iso).toLocaleString();
    let text = "Slot seleccionado: " + local + " (15s)";
    if(existingSchedule){
      const schedStart = new Date(existingSchedule.startTime);
      const selected = new Date(iso);
      if(schedStart.getTime() === selected.getTime()){
        text += " · OCUPADO por " + existingSchedule.id;
      } else {
        text += " · Disponible";
      }
      const schedLocal = schedStart.toLocaleString();
      existingSlotInfo.textContent = "Próxima programación actual: " + existingSchedule.id + " · " + schedLocal;
    }
    slotInfo.textContent = text;
  }

  async function fetchExistingSchedule(apiBase){
    try{
      const res = await fetch(apiBase + "/schedule/next", { cache: "no-store" });
      if(!res.ok){
        existingSlotInfo.textContent = "No hay programación cargada aún.";
        updateSlotDisplay(null);
        return null;
      }
      const data = await res.json();
      updateSlotDisplay(data);
      return data;
    }catch(e){
      existingSlotInfo.textContent = "No se pudo consultar la programación.";
      updateSlotDisplay(null);
      return null;
    }
  }

  dateInput.addEventListener("change", () => updateSlotDisplay(null));
  hourSelect.addEventListener("change", () => updateSlotDisplay(null));
  minuteSelect.addEventListener("change", () => updateSlotDisplay(null));
  secondSelect.addEventListener("change", () => updateSlotDisplay(null));

  // ----- PASO 1 -----
  step1Next.addEventListener("click", async function(){
    statusStep1.textContent = "";
    statusStep1.className = "status";
    const api = apiInput.value.trim().replace(/\/$/,"");
    if(!api){
      statusStep1.textContent = "Falta API URL.";
      statusStep1.classList.add("err");
      return;
    }
    const iso = getSelectedSlotIso();
    if(!iso){
      statusStep1.textContent = "Selecciona fecha y hora válidas.";
      statusStep1.classList.add("err");
      return;
    }
    const now = new Date();
    const selected = new Date(iso);
    if(selected.getTime() <= now.getTime()){
      statusStep1.textContent = "El slot debe ser en el futuro.";
      statusStep1.classList.add("err");
      return;
    }

    const existing = await fetchExistingSchedule(api);
    if(existing){
      const schedStart = new Date(existing.startTime);
      if(schedStart.getTime() === selected.getTime()){
        statusStep1.textContent = "Ese bloque de 15s ya está ocupado por la orden " + existing.id + ".";
        statusStep1.classList.add("err");
        return;
      }
    }

    state.apiBase = api;
    state.scheduledAtIso = iso;
    state.scheduledLocal = selected.toLocaleString();
    state.city = cityInput.value.trim();
    state.screen = screenInput.value;

    summaryScreen.textContent = state.screen;
    summaryCity.textContent = state.city;
    summaryTime.textContent = state.scheduledLocal;

    setStep(2);
  });

  // ----- PASO 2 -----
  backTo1.addEventListener("click", () => setStep(1));

  processVideoBtn.addEventListener("click", async function(){
    statusStep2.textContent = "";
    statusStep2.className = "status";
    const api = state.apiBase;
    if(!api){
      statusStep2.textContent = "Configura primero el Paso 1.";
      statusStep2.classList.add("err");
      return;
    }
    const file = videoFileInput.files && videoFileInput.files[0];
    if(!file){
      statusStep2.textContent = "Selecciona un archivo de video.";
      statusStep2.classList.add("err");
      return;
    }
    state.file = file;
    state.trimStart = Number(startRange.value) || 0;

    processVideoBtn.disabled = true;
    continueTo3Btn.disabled = true;
    state.previewReady = false;
    processVideoBtn.textContent = "Procesando…";

    try{
      const fd = new FormData();
      fd.append("file", file);
      fd.append("start", String(state.trimStart));
      fd.append("length", "15");

      const res = await fetch(api + "/media/trim", {
        method: "POST",
        body: fd
      });

      if(!res.ok){
        const text = await res.text();
        throw new Error(text || "Error al generar preview");
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      previewVideo.src = url;
      previewVideo.play().catch(() => {});
      state.previewReady = true;
      continueTo3Btn.disabled = false;
      statusStep2.textContent = "Preview generado correctamente. Ahora puedes continuar al pago.";
      statusStep2.classList.add("ok");
    } catch(e){
      console.error(e);
      statusStep2.textContent = e.message || "Error inesperado al procesar el video.";
      statusStep2.classList.add("err");
    } finally {
      processVideoBtn.disabled = false;
      processVideoBtn.textContent = "Procesar video";
    }
  });

  continueTo3Btn.addEventListener("click", function(){
    if(!state.previewReady){
      statusStep2.textContent = "Primero procesa el video para ver el preview.";
      statusStep2.classList.add("err");
      return;
    }
    setStep(3);
  });

  // ----- PASO 3 -----
  backTo2.addEventListener("click", () => setStep(2));

  payBtn.addEventListener("click", async function(){
    statusStep3.textContent = "";
    statusStep3.className = "status";
    if(!state.apiBase || !state.scheduledAtIso || !state.file){
      statusStep3.textContent = "Falta información del paso 1 o 2.";
      statusStep3.classList.add("err");
      return;
    }

    payBtn.disabled = true;
    payBtn.textContent = "Programando…";

    try{
      const fd = new FormData();
      fd.append("file", state.file);
      fd.append("start", String(state.trimStart));
      fd.append("scheduledAt", state.scheduledAtIso);

      const res = await fetch(state.apiBase + "/media/trim-set", {
        method: "POST",
        body: fd
      });

      const text = await res.text();
      if(!res.ok){
        throw new Error(text || "Error al programar spot");
      }
      let data;
      try{ data = JSON.parse(text); }catch{ data = { raw:text }; }

      const schedule = data && data.schedule;
      if(schedule){
        state.orderId = schedule.id;
        const local = new Date(schedule.startTime).toLocaleString();
        state.scheduledLocal = local;
        summaryTime.textContent = local;
        summaryOrder.textContent = schedule.id;
        statusStep3.textContent = "Pago simulado OK. Spot programado como " + schedule.id + ".";
        statusStep3.classList.add("ok");
      }else{
        statusStep3.textContent = "Pago simulado OK, pero sin datos de programación.";
        statusStep3.classList.add("ok");
      }
    }catch(e){
      console.error(e);
      statusStep3.textContent = e.message || "Error al programar el spot.";
      statusStep3.classList.add("err");
    }finally{
      payBtn.disabled = false;
      payBtn.textContent = "Simular pago y programar";
    }
  });

  // Consultar programación existente al cargar
  fetchExistingSchedule(apiInput.value.trim().replace(/\/$/,""));
})();
</script>
</body>
</html>
